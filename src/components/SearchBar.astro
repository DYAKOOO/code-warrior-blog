---
import { getCollection } from 'astro:content';

const allPosts = await getCollection('blog');

interface Props {
  placeholder?: string;
}

const { placeholder = "Search posts or tags..." } = Astro.props;

// Prepare data for Fuse.js
const searchData = allPosts.map(post => ({
  title: post.data.title,
  description: post.data.description,
  tags: post.data.tags,
  slug: post.slug,
}));
---

<div class="search-container mb-8">
  <input
    type="text"
    id="search-input"
    placeholder={placeholder}
    class="w-full p-2 border border-gray-300 rounded-md"
  />
  <div id="search-results" class="mt-4 space-y-4"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
<script define:vars={{ searchData }}>
  const searchInput = document.getElementById('search-input');
  const searchResults = document.getElementById('search-results');

  const fuse = new Fuse(searchData, {
    keys: ['title', 'description', 'tags'],
    threshold: 0.3,
    ignoreLocation: true,
  });

  searchInput.addEventListener('input', (e) => {
    const searchTerm = e.target.value;
    
    if (searchTerm === '') {
      searchResults.innerHTML = '';
      return;
    }

    const results = fuse.search(searchTerm);

    searchResults.innerHTML = results.map(result => `
      <div class="search-result bg-surface p-4 rounded-lg shadow-md">
        <a href="/blog/${result.item.slug}" class="text-lg font-semibold text-accent hover:underline">
          ${result.item.title}
        </a>
        <p class="text-text-secondary mt-2">${result.item.description}</p>
        <div class="mt-2 flex flex-wrap gap-2">
          ${result.item.tags.map(tag => `
            <span class="bg-gray-200 px-2 py-1 rounded-full text-sm text-gray-700">
              ${tag}
            </span>
          `).join('')}
        </div>
      </div>
    `).join('');
  });
</script>